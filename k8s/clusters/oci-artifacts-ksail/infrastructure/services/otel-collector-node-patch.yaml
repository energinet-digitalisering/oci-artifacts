apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: otel-collector-node
  namespace: otel-collector-k8s
spec:
  values:
    config:
      exporters:
        prometheusremotewrite:
          endpoint: http://mimir-distributor.mimir:8080/api/v1/push
          headers:
            x-scope-orgid: oci-artifacts-ksail
        loki:
          endpoint: http://loki.loki:3100/loki/api/v1/push
          headers:
            x-scope-orgid: oci-artifacts-ksail

      processors:
        resource/loki:
          attributes:
            - action: insert
              key: loki.resource.labels
              value: k8s.namespace.name, k8s.node.name

        transform/prometheus:
          metric_statements:
            - context: datapoint
              statements:
              - set(attributes["namespace"], resource.attributes["k8s.namespace.name"])
              - set(attributes["node"], resource.attributes["k8s.node.name"])
              - set(attributes["pod"], resource.attributes["k8s.pod.name"])
              - set(attributes["container"], resource.attributes["k8s.container.name"])

      service:
        pipelines:
          metrics:
            exporters:
              - prometheusremotewrite
              - debug
            processors:
              - k8sattributes
              - transform/prometheus
              - memory_limiter
              - batch
          logs:
            exporters:
              - loki
              - debug
            processors:
              - k8sattributes
              - resource/loki
              - memory_limiter
              - batch
